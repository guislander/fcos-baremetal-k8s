variant: fcos
version: 1.1.0
storage:
  directories:
  - path: /opt/adjusted-selinux-policy
    overwrite: true
  files:
    - 
      #
      # Istio SELinux policy source file (re: https://github.com/istio/istio/issues/24101)
      #
      path: /opt/adjusted-selinux-policy/allow-iptables-restor.te
      overwrite: true
      contents: 
        inline: |
          module allow-iptables-restor 1.0;
          require {
          type kernel_t;
          type container_t;
          class system module_request;
          }
          allow container_t kernel_t:system module_request;
    - 
      #
      # minio SELinux policy source file
      #
      path: /opt/adjusted-selinux-policy/allow-container-dir-create.te
      overwrite: true
      contents: 
        inline: |
          module allow-container-dir-create 1.0;
          require {
          type container_t;
          type container_var_lib_t;
          class dir create;
          }
          allow container_t container_var_lib_t:dir create;

systemd:
  units:
    - name: adj-iptables.service
      #
      # Modifying selinux policy for iptables to enable Istio capabilities
      # (re: https://download.geo.drweb.com/pub/drweb/unix/doc/HTML/ControlCenter/en/dw_8_install_selinux.htm)
      #
      enabled: true
      contents: |
        [Unit]
        Description=Adjust SELinux policy
        ConditionPathExists=/opt/adjusted-selinux-policy/allow-iptables-restor.te
        ConditionPathExists=/opt/adjusted-selinux-policy/allow-container-dir-create.te
        Wants=install-checkpolicy.service
        After=install-checkpolicy.service
        After=multi-user.target

        [Service]
        Type=oneshot
        ExecStart=checkmodule -M -m -o /opt/adjusted-selinux-policy/allow-container-dir-create.mod /opt/adjusted-selinux-policy/allow-container-dir-create.te
        ExecStart=semodule_package -o /opt/adjusted-selinux-policy/allow-container-dir-create.pp -m /opt/adjusted-selinux-policy/allow-container-dir-create.mod
        ExecStart=semodule -i /opt/adjusted-selinux-policy/allow-container-dir-create.pp
        ExecStart=checkmodule -M -m -o /opt/adjusted-selinux-policy/allow-iptables-restor.mod /opt/adjusted-selinux-policy/allow-iptables-restor.te
        ExecStart=semodule_package -o /opt/adjusted-selinux-policy/allow-iptables-restor.pp -m /opt/adjusted-selinux-policy/allow-iptables-restor.mod
        ExecStart=semodule -i /opt/adjusted-selinux-policy/allow-iptables-restor.pp

        [Install]
        WantedBy=multi-user.target

